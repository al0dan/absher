<!DOCTYPE html>
<html lang="ar" class="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مركز القيادة - أبشر أعمال</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Strict Reset for Dashboard */
        * {
            box-sizing: border-box;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            /* Wider main area */
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles - Stricter Gov Style */
        .dash-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            /* Sharper corners */
            padding: 20px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
            /* Subtler shadow */
            margin-bottom: 20px;
            overflow: hidden;
            /* Prevent overflow */
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 12px;
        }

        .dash-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--business-theme-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Action Center - Refined */
        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fffdf5;
            /* Very subtle yellow */
            border: 1px solid #ffeeba;
            border-right: 4px solid #ffbd2e;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .action-item:last-child {
            margin-bottom: 0;
        }

        /* Quick Actions Grid - No Emojis */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        @media (max-width: 600px) {
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .action-btn {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .action-btn:hover {
            border-color: var(--business-theme-color);
            background: #f8fbff;
            color: var(--business-theme-color);
            transform: translateY(-2px);
        }

        .action-icon-svg {
            width: 32px;
            height: 32px;
            stroke-width: 1.5;
            color: var(--business-theme-color);
        }

        /* Analytics */
        .analytics-row {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            flex: 1;
            padding-right: 20px;
            border-right: 1px solid #eee;
        }

        .stat-box:first-child {
            padding-right: 0;
            border-right: none;
        }

        /* Table - No Emojis */
        .absher-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .absher-table th {
            background: #f9f9f9;
            padding: 12px;
            text-align: right;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .absher-table td {
            padding: 14px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }

        .absher-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .bg-green {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .bg-orange {
            background: #fff3e0;
            color: #ef6c00;
        }

        .type-icon {
            color: #777;
            width: 16px;
            height: 16px;
            vertical-align: middle;
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <!-- Standard Header -->
    <header class="top-header">
        <div class="top-header-inner">
            <div class="header-left">
                <img src="/img/Absher_Business_logo.svg" alt="Absher" class="logo-absher" style="height: 80px;">
            </div>
            <div class="header-right">
                <div class="header-center">
                    <a id="switchLang" href="javascript:void(0);" class="lang-switch">
                        <span class="ar-text">English</span>
                        <span class="en-text">العربية</span>
                        <img src="/img/globe.svg" class="globe">
                    </a>
                </div>
                <a href="/logout"
                    style="color: #666; text-decoration: none; margin-left: 15px; font-weight: 500; display: flex; align-items: center; gap: 5px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    <span>تسجيل الخروج</span>
                </a>
                <img src="/img/vission-logo.png" style="height:55px; margin-left:10px;">
                <img src="/img/moi-logo.svg" style="height:55px">
            </div>
        </div>
    </header>

    <main class="absher-form-section" style="max-width: 1200px; margin: 30px auto; padding: 0 20px;">

        <!-- Welcome & Breadcrumb -->
        <div
            style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
            <div>
                <div style="font-size: 12px; color: #888; margin-bottom: 8px;">الرئيسية > مركز القيادة</div>
                <h1 style="margin: 0; font-size: 24px; color: var(--business-theme-color);">أهلاً بك، {{ user.name }}
                </h1>
            </div>
            <div style="text-align: left;">
                <div style="font-size: 11px; color: #888;">حالة الحساب</div>
                <div
                    style="color: #2e7d32; font-weight: bold; display: flex; align-items: center; gap: 5px; font-size: 14px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z" />
                    </svg>
                    نشط - موثّق
                </div>
            </div>
        </div>

        <div class="dashboard-grid">

            <!-- RIGHT COLUMN (Main Content) -->
            <div>
                <!-- Action Center -->
                {% if actions_required %}
                <div class="dash-card" style="border-top: 3px solid #ffbd2e;">
                    <div class="dash-header" style="border-bottom: none; padding-bottom: 0;">
                        <div class="dash-title" style="color: #d68f00;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            إجراءات تتطلب انتباهك
                        </div>
                    </div>
                    {% for action in actions_required %}
                    <div class="action-item">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #eee;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                                    viewBox="0 0 24 24" stroke="#ffbd2e">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight: bold; font-size: 14px;">عقد بانتظار التوقيع #{{ action.id }}
                                </div>
                                <div style="font-size: 11px; color: #666;">الطرف الآخر: {{ action.buyer if
                                    action.supplier_cr == user.cr else action.supplier }}</div>
                            </div>
                        </div>
                        <a href="/contract/{{ action.id }}" class="btn-absher"
                            style="padding: 6px 20px; font-size: 12px; margin: 0;">توقيع</a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Financial Overview -->
                <div class="dash-card">
                    <div class="analytics-row">
                        <div class="stat-box">
                            <div style="font-size: 12px; color: #777; margin-bottom: 5px;">إجمالي قيمة العقود</div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--business-theme-color);">{{
                                "{:,.2f}".format(total_value) }} <span
                                    style="font-size: 14px; font-weight: normal; color: #666;">ر.س</span></div>
                        </div>
                        <div class="stat-box" style="border-right: 1px solid #eee; padding-right: 20px;">
                            <div style="font-size: 12px; color: #777; margin-bottom: 5px;">العقود النشطة</div>
                            <div style="font-size: 28px; font-weight: 700; color: #333;">{{ status_stats.signed }}</div>
                        </div>
                        <div class="stat-box" style="border-right: 1px solid #eee; padding-right: 20px;">
                            <div style="font-size: 12px; color: #777; margin-bottom: 5px;">قيد الانتظار</div>
                            <div style="font-size: 28px; font-weight: 700; color: #ef6c00;">{{ status_stats.pending }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Contracts -->
                <div class="dash-card" style="padding: 0;">
                    <div class="dash-header" style="margin: 20px 20px 10px 20px;">
                        <div class="dash-title">أحدث العقود</div>
                        <a href="#" style="font-size: 12px; color: var(--business-theme-color);">عرض الأرشيف</a>
                    </div>
                    <table class="absher-table">
                        <thead>
                            <tr>
                                <th>رقم العقد</th>
                                <th>الطرف الثاني</th>
                                <th>القيمة</th>
                                <th>النوع</th>
                                <th>الحالة</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in contracts[:5] %}
                            <tr>
                                <td style="font-weight: bold; font-family: monospace;">#{{ c.id }}</td>
                                <td>{{ c.buyer }}</td>
                                <td>{{ c.price }}</td>
                                <td>
                                    <!-- Icons instead of Emojis -->
                                    {% if c.contract_type == 'supply' %}
                                    <svg class="type-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                    </svg> توريد
                                    {% elif c.contract_type == 'service' %}
                                    <svg class="type-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                                    </svg> خدمات
                                    {% elif c.contract_type == 'nda' %}
                                    <svg class="type-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg> NDA
                                    {% else %}
                                    <svg class="type-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg> عام
                                    {% endif %}
                                </td>
                                <td>
                                    {% if c.signed_by_supplier and c.signed_by_buyer %}
                                    <span class="status-badge bg-green">مكتمل</span>
                                    {% else %}
                                    <span class="status-badge bg-orange">قيد الإجراء</span>
                                    {% endif %}
                                </td>
                                <td><a href="/contract/{{ c.id }}"
                                        style="color: var(--business-theme-color); font-size: 12px; font-weight: bold;">عرض</a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if not contracts %}
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 30px; color: #999;">لا توجد تعاملات
                                    حديثة</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Quick Access Bottom -->
                <h3 style="color: #444; margin-bottom: 15px; font-size: 18px;">الخدمات السريعة</h3>
                <div class="quick-actions">
                    <a href="/create?type=supply" class="action-btn">
                        <svg class="action-icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <div>عقد توريد</div>
                    </a>
                    <a href="/create?type=service" class="action-btn">
                        <svg class="action-icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <div>عقد خدمات</div>
                    </a>
                    <a href="/create?type=nda" class="action-btn">
                        <svg class="action-icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <div>عدم إفصاح</div>
                    </a>
                    <a href="/create?type=rental" class="action-btn">
                        <svg class="action-icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        <div>عقد إيجار</div>
                    </a>
                </div>
            </div>

            <!-- LEFT COLUMN (Sidebar) -->
            <div>
                <!-- Create New - Fixed Padding/Overflow -->
                <div class="dash-card"
                    style="background: linear-gradient(145deg, var(--business-theme-color) 0%, #155e96 100%); color: white; border: none; padding: 25px;">
                    <h3 style="margin-top: 0; font-size: 20px;">إنشاء عقد جديد</h3>
                    <p style="font-size: 13px; opacity: 0.9; margin-bottom: 20px; line-height: 1.6;">وثّق تعاملاتك
                        التجارية الآن بموثوقية وحماية قانونية كاملة.</p>
                    <a href="/create" class="btn-absher"
                        style="background: white; color: var(--business-theme-color); width: 100%; display: block; text-align: center; border: none;">+
                        إنشاء عقد الآن</a>
                </div>

                <!-- Visuals -->
                <div class="dash-card">
                    <div class="dash-title" style="font-size: 14px; margin-bottom: 15px;">توزيع العقود</div>
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="typeChart"></canvas>
                    </div>
                </div>

                <div class="dash-card">
                    <div class="dash-title" style="font-size: 14px; margin-bottom: 15px;">حالة التوقيع</div>
                    <div class="chart-container" style="height: 180px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- Official Government Footer -->
    <footer class="absher-footer">
        <div class="footer-inner">
            <div class="footer-col" style="flex: 1.5;">
                <img src="/img/Absher_Business_logo.svg" alt="Absher"
                    style="height: 60px; margin-bottom: 20px; filter: grayscale(100%); opacity: 0.7;">
                <p style="color: #777; line-height: 1.8; font-size: 14px; max-width: 300px;">
                    منصة أبشر أعمال هي المنصة الرسمية لخدمات الأعمال الإلكترونية لوزارة الداخلية، وتهدف إلى تمكين
                    المنشآت من القيام بجميع التعاملات الحكومية إلكترونياً.
                </p>
            </div>

            <div class="footer-col" style="flex: 1;">
                <h4>خدمات المنصة</h4>
                <ul>
                    <li><a href="/service">توثيق العقود</a></li>
                    <li><a href="#">التفاويض الإلكترونية</a></li>
                    <li><a href="#">تأشيرات العمل</a></li>
                    <li><a href="#">تجديد السجلات</a></li>
                </ul>
            </div>

            <div class="footer-col" style="flex: 1;">
                <h4>المساعدة والدعم</h4>
                <ul>
                    <li><a href="#">الأسئلة الشائعة</a></li>
                    <li><a href="#">اتصل بنا (920020405)</a></li>
                    <li><a href="#">دليل المستخدم</a></li>
                    <li><a href="#">سياسة الخصوصية</a></li>
                </ul>
            </div>

            <div class="footer-col" style="flex: 1;">
                <h4>تطبيقات الجوال</h4>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button
                        style="background: #000; color: #fff; border:none; border-radius: 6px; padding: 8px 15px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 1.018a.96.96 0 0 0-.279.12l-5.69 3.284a1.002 1.002 0 0 0 0 1.737l5.69 3.284a.96.96 0 0 0 .558 0l5.69-3.284a1.002 1.002 0 0 0 0-1.737L8.279 1.138A.96.96 0 0 0 8 1.018z" />
                        </svg>
                        <span style="font-family: sans-serif; font-size: 12px;">App Store</span>
                    </button>
                    <button
                        style="background: #000; color: #fff; border:none; border-radius: 6px; padding: 8px 15px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                            viewBox="0 0 16 16">
                            <path
                                d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z" />
                        </svg>
                        <span style="font-family: sans-serif; font-size: 12px;">Google Play</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <div>جميع الحقوق محفوظة © أبشر أعمال 2024 - وزارة الداخلية</div>
            <div style="display: flex; gap: 20px;">
                <img src="/img/vission-logo.png" style="height: 35px; filter: grayscale(100%); opacity: 0.6;">
                <img src="/img/moi-logo.svg" style="height: 35px; filter: grayscale(100%); opacity: 0.6;">
            </div>
        </div>
    </footer>

    <script>
        // Charts Data
        const typeData = {{ type_stats| tojson }};
        const statusData = {{ status_stats| tojson }};

        // Type Chart
        new Chart(document.getElementById('typeChart'), {
            type: 'doughnut',
            data: {
                labels: ['توريد', 'خدمات', 'NDA', 'عام'],
                datasets: [{
                    data: [typeData.supply, typeData.service, typeData.nda, (typeData.rental + (typeData.general || 0))],
                    backgroundColor: ['#00838f', '#00bfa5', '#ffa000', '#5d4037'],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                plugins: { legend: { display: false } }, // Minimal look
                maintainAspectRatio: false
            }
        });

        // Status Chart
        new Chart(document.getElementById('statusChart'), {
            type: 'pie',
            data: {
                labels: ['مكتمل', 'معلق'],
                datasets: [{
                    data: [statusData.signed, statusData.pending],
                    backgroundColor: ['#2e7d32', '#ef6c00'],
                    borderWidth: 0
                }]
            },
            options: {
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true } } },
                maintainAspectRatio: false
            }
        });

        // Lang Switch logic
        const switchLang = document.getElementById('switchLang');
        if (switchLang) {
            switchLang.addEventListener('click', () => {
                const html = document.documentElement;
                if (html.lang === 'ar') {
                    html.lang = 'en'; html.classList.remove('rtl'); html.classList.add('ltr');
                } else {
                    html.lang = 'ar'; html.classList.remove('ltr'); html.classList.add('rtl');
                }
            });
        }
    </script>
</body>

</html>